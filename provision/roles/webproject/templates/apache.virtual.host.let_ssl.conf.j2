<VirtualHost *:80>
   ServerName {{ domain }}
   Redirect permanent / https://{{ domain }}
</VirtualHost>

<IfModule mod_ssl.c>
    <VirtualHost _default_:443>
        ServerAdmin webmaster@{{ domain }}
        ServerName {{ domain }}
        ServerAlias www.{{ domain }}

        ErrorLog ${APACHE_LOG_DIR}/{{ domain }}_error.log
        CustomLog ${APACHE_LOG_DIR}/{{ domain }}_access.log combined

        SSLCertificateFile /etc/letsencrypt/live/{{ domain }}/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/{{ domain }}/privkey.pem
        Include /etc/letsencrypt/options-ssl-apache.conf

        DocumentRoot {% if public_html is defined %}{{ public_html }}{% else %}{{ workspace }}{% endif %}

        <Directory {% if public_html is defined %}{{ public_html }}{% else %}{{ workspace }}{% endif %}>
            Require all granted
            AllowOverride All
        </Directory>

        <IfModule mod_fastcgi.c>
            AddType application/x-httpd-fastphp .php
            Action application/x-httpd-fastphp /php-fcgi
            Alias /php-fcgi /usr/lib/cgi-bin/php-https-{{ domain }}-fcgi
            FastCgiExternalServer /usr/lib/cgi-bin/php-https-{{ domain }}-fcgi -socket /run/php/{{ domain }}.sock -pass-header Authorization
            <Directory /usr/lib/cgi-bin>
                Require all granted
            </Directory>
        </IfModule>
    </VirtualHost>
</IfModule>
